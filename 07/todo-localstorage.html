<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>투두리스트 (localStorage 저장)</title>
<style>
  :root { --bg:#f5f6fa; --card:#fff; --ink:#222; --muted:#6b7280; --brand:#2563eb; --ok:#10b981; --danger:#ef4444; --line:#e5e7eb; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; }
  .wrap { max-width: 760px; margin: 40px auto; padding: 0 16px; }
  .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
  header { padding: 22px 20px 0; }
  h1 { margin:0; font-size: 22px; }
  p.lead { margin:8px 0 18px; color:var(--muted); font-size: 14px; }
  main { padding: 0 20px 20px; }
  .row { display:flex; gap:8px; align-items:center; }
  input[type="text"] { flex:1; padding:12px 12px; border-radius:10px; border:1px solid var(--line); outline: none; }
  input[type="text"]:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
  button { border: none; border-radius: 10px; padding: 11px 14px; cursor: pointer; font-weight: 600; }
  .btn { background: var(--brand); color:#fff; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .btn.ghost { background: transparent; color: var(--brand); border:1px solid var(--brand); }
  .btn.danger { background: var(--danger); color:#fff; }
  .bar { display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:8px; flex-wrap: wrap; }
  .filters { display:flex; gap:6px; flex-wrap: wrap; }
  .chip { padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; color:var(--muted); font-size:13px; cursor:pointer; }
  .chip.active { border-color: var(--brand); color: var(--brand); }
  ul { list-style: none; padding:0; margin: 14px 0 0; }
  li { display:grid; grid-template-columns: 28px 1fr 72px; align-items:center; gap:8px;
       padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; margin-bottom:8px; }
  li.completed .text { color:#9ca3af; text-decoration: line-through; }
  .check { display:flex; justify-content:center; }
  .text { padding:8px 10px; border-radius:8px; min-height: 38px; display:flex; align-items:center; }
  .text[contenteditable="true"] { outline: none; border:1px dashed var(--brand); background: #f0f6ff; }
  .actions { display:flex; gap:6px; justify-content:flex-end; }
  .small { color: var(--muted); font-size:12px; }
  .empty { text-align:center; color: var(--muted); padding: 24px 8px; }
  footer { padding: 12px 20px 18px; border-top:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; }
  .count { color: var(--muted); font-size: 13px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>📋 투두리스트</h1>
      <p class="lead">할 일을 추가/완료/삭제하고, <strong>localStorage</strong>에 자동 저장됩니다.</p>
    </header>
    <main>
      <div class="row">
        <input id="input" type="text" placeholder="할 일을 입력 후 Enter 또는 추가 버튼">
        <button id="add" class="btn">추가</button>
      </div>

      <div class="bar">
        <div class="filters">
          <button class="chip active" data-filter="all">전체</button>
          <button class="chip" data-filter="active">진행중</button>
          <button class="chip" data-filter="completed">완료</button>
        </div>
        <div class="row">
          <button id="clearDone" class="btn ghost">완료 항목 삭제</button>
          <button id="clearAll" class="btn danger">전체 삭제</button>
        </div>
      </div>

      <ul id="list"></ul>
      <div id="empty" class="empty" style="display:none">할 일이 없습니다. 새로 추가해 보세요.</div>
    </main>
    <footer>
      <span class="count" id="count">0개</span>
      <span class="small">저장 키: <code>todo:v1</code></span>
    </footer>
  </div>
</div>

<script>
(function(){
  const KEY = 'todo:v1';
  const $input = document.getElementById('input');
  const $add = document.getElementById('add');
  const $list = document.getElementById('list');
  const $count = document.getElementById('count');
  const $clearAll = document.getElementById('clearAll');
  const $clearDone = document.getElementById('clearDone');
  const $chips = [...document.querySelectorAll('.chip')];
  const $empty = document.getElementById('empty');

  let state = {
    tasks: [],  // {id, text, done, createdAt}
    filter: 'all' // all | active | completed
  };

  // --- Storage helpers ---
  function save() {
    try { localStorage.setItem(KEY, JSON.stringify(state)); }
    catch (e) { console.warn('localStorage 저장 실패', e); }
  }
  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (data && Array.isArray(data.tasks)) {
        state.tasks = data.tasks;
        state.filter = data.filter || 'all';
      }
    } catch (e) {
      console.warn('localStorage 로드 실패', e);
    }
  }

  // --- State ops ---
  function addTask(text) {
    const t = text.trim();
    if (!t) return;
    state.tasks.push({ id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()), text: t, done:false, createdAt: Date.now() });
    save(); render();
  }
  function toggleTask(id) {
    const it = state.tasks.find(x=>x.id===id);
    if (!it) return;
    it.done = !it.done;
    save(); render();
  }
  function deleteTask(id) {
    state.tasks = state.tasks.filter(x=>x.id!==id);
    save(); render();
  }
  function editTask(id, text) {
    const it = state.tasks.find(x=>x.id===id);
    if (!it) return;
    it.text = text.trim() || it.text; // 빈 편집은 무시
    save(); render();
  }
  function clearDone() {
    state.tasks = state.tasks.filter(t=>!t.done);
    save(); render();
  }
  function clearAll() {
    if (!confirm('모든 할 일을 삭제할까요?')) return;
    state.tasks = [];
    save(); render();
  }
  function setFilter(f) {
    state.filter = f; save(); render();
  }

  function filtered() {
    switch(state.filter){
      case 'active': return state.tasks.filter(t=>!t.done);
      case 'completed': return state.tasks.filter(t=>t.done);
      default: return state.tasks;
    }
  }

  // --- Render ---
  function render() {
    // chips
    $chips.forEach(c=>c.classList.toggle('active', c.dataset.filter===state.filter));

    const items = filtered();
    $list.innerHTML = '';
    if (items.length===0) {
      $empty.style.display = 'block';
    } else {
      $empty.style.display = 'none';
    }

    for (const t of items) {
      const li = document.createElement('li');
      if (t.done) li.classList.add('completed');
      li.dataset.id = t.id;

      // checkbox
      const check = document.createElement('input');
      check.type = 'checkbox';
      check.checked = t.done;
      check.addEventListener('change', ()=> toggleTask(t.id));

      const checkWrap = document.createElement('div');
      checkWrap.className = 'check';
      checkWrap.appendChild(check);

      // text (editable)
      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = t.text;
      text.title = '더블클릭하여 편집';
      text.addEventListener('dblclick', ()=> makeEditable(text, t));

      // actions
      const actions = document.createElement('div');
      actions.className = 'actions';
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = '삭제';
      del.addEventListener('click', ()=> deleteTask(t.id));
      actions.appendChild(del);

      li.appendChild(checkWrap);
      li.appendChild(text);
      li.appendChild(actions);
      $list.appendChild(li);
    }

    // count
    const total = state.tasks.length;
    const left = state.tasks.filter(t=>!t.done).length;
    $count.textContent = `${total}개 (미완료 ${left}개)`;
  }

  function makeEditable(textEl, task) {
    textEl.setAttribute('contenteditable', 'true');
    textEl.focus();
    placeCaretAtEnd(textEl);

    function finish(commit=true){
      textEl.removeAttribute('contenteditable');
      textEl.removeEventListener('keydown', onKey);
      textEl.removeEventListener('blur', onBlur);
      if (commit) editTask(task.id, textEl.textContent);
      else render(); // revert display
    }
    function onKey(e){
      if (e.key==='Enter') { e.preventDefault(); finish(true); }
      else if (e.key==='Escape') { e.preventDefault(); finish(false); }
    }
    function onBlur(){ finish(true); }

    textEl.addEventListener('keydown', onKey);
    textEl.addEventListener('blur', onBlur);
  }

  function placeCaretAtEnd(el){
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(el);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  // --- Events ---
  $add.addEventListener('click', ()=> addTask($input.value));
  $input.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') addTask($input.value);
  });
  $clearAll.addEventListener('click', clearAll);
  $clearDone.addEventListener('click', clearDone);
  $chips.forEach(ch => ch.addEventListener('click', ()=> setFilter(ch.dataset.filter)));

  // --- Init ---
  load(); render();
})();
</script>
</body>
</html>
